<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<title>MigatingWeb2pyFromSQLiteToMySQL</title>
<link rel="stylesheet" type="text/css" media="all" charset="utf-8" href="pythonanywhere/css/common.css">
<link rel="stylesheet" type="text/css" media="screen" charset="utf-8" href="pythonanywhere/css/screen.css">
<link rel="stylesheet" type="text/css" media="print" charset="utf-8" href="pythonanywhere/css/print.css">
<style type="text/css">
ul.pagetitle{
  display: inline;
  margin: 0;
  padding: 0;
  font-size: 1.5em;
}
li.pagetitle{
  display: inline;
  margin: 0;
}
td.noborder {
  border: 0;
}
</style>
</head>
<body>
<table>
<tr>
<td class="noborder">
<img src="logo.png">
</td>
<td class="noborder">
<ul class="pagetitle">
<li class="pagetitle"><a class="backlink">MigatingWeb2pyFromSQLiteToMySQL</a>
</ul>
<br><br>
[<a href="PythonAnywhereWiki.html">PythonAnywhereWiki</a>]&nbsp;[<a href="TitleIndex.html">TitleIndex</a>]&nbsp;[<a href="WordIndex.html">WordIndex</a>]&nbsp;
</td>
</tr>
</table>
<hr>
<div id="page">
<div dir="ltr" id="content" lang="en"><span class="anchor" id="top"></span>
<span class="anchor" id="line-1"></span><p class="line867"><em>From <a href="./PythonAnywhere.html">PythonAnywhere</a> user mjbeller <a class="https" href="https://www.pythonanywhere.com/forums/topic/1288/#id_post_8992">in the forums</a></em> <span class="anchor" id="line-2"></span><span class="anchor" id="line-3"></span><p class="line874">I've been using web2py and sqlite for both prototyping and the first version of an application.  For both performance and scalability, I need to move to MySQL.  Over the past week I've experimented with several options and here's what worked for me (and hope this helps others) ... <span class="anchor" id="line-4"></span><span class="anchor" id="line-5"></span><p class="line874">The web2py book describes two methods: <span class="anchor" id="line-6"></span><span class="anchor" id="line-7"></span><ul><li><p class="line862">export/import all data using CSV files (<a class="http" href="http://web2py.com/books/default/chapter/29/06/the-database-abstraction-layer#CSV--all-tables-at-once-">http://web2py.com/books/default/chapter/29/06/the-database-abstraction-layer#CSV--all-tables-at-once-</a>) <span class="anchor" id="line-8"></span></li><li><p class="line862">copy between databases using script cpdb.py (<a class="http" href="http://web2py.com/books/default/chapter/29/06/the-database-abstraction-layer?search=cpdb#Copy-data-from-one-db-into-another">http://web2py.com/books/default/chapter/29/06/the-database-abstraction-layer?search=cpdb#Copy-data-from-one-db-into-another</a>) <span class="anchor" id="line-9"></span><span class="anchor" id="line-10"></span></li></ul><p class="line874">The web2py user group highlights two other options: <span class="anchor" id="line-11"></span><span class="anchor" id="line-12"></span><ul><li><p class="line862">sqlite .dump and mysql migration per <a class="http" href="http://www.realpython.com/blog/python/web2py-migrating-from-sqlite-to-mysql/#.Ulm3xmTTXCU">http://www.realpython.com/blog/python/web2py-migrating-from-sqlite-to-mysql/#.Ulm3xmTTXCU</a> <span class="anchor" id="line-13"></span></li><li><p class="line862">Mariano/Alan Etkin experimental script - <a class="https" href="https://groups.google.com/d/msg/web2py-developers/QxeJNByj6qc/cpBHsa1ymUkJ">https://groups.google.com/d/msg/web2py-developers/QxeJNByj6qc/cpBHsa1ymUkJ</a> <span class="anchor" id="line-14"></span><span class="anchor" id="line-15"></span></li></ul><p class="line874">I couldn't get cpdb to work except for a simple model.  I'm still learning both python and web2py and couldn't debug the script but believe it has something to do with the sequence and dependencies between tables (I have about 12 tables with numerous foreign keys).  This is also true of using sqlite .dump and mysql migrate (and I also felt this bypassed web2py which requires a fake_migrate and preferred an option "within" web2py since I'm also learning MySQL at the same time). <span class="anchor" id="line-16"></span><span class="anchor" id="line-17"></span><p class="line874">The experimental script seemed straightforward but <span class="anchor" id="line-18"></span><span class="anchor" id="line-19"></span><p class="line874">1. I wasn't sure how to execute the script with both DAL's simultaneously and <span class="anchor" id="line-20"></span>2. the primary advantage over CSV export/import is the retention of the source row id's (which isn't needed if you start with a new database schema - see my comments below). <span class="anchor" id="line-21"></span><span class="anchor" id="line-22"></span><p class="line874">In the end, I used the following procedure using web2py CSV export/import to move my production sqlite db to mysql (which only took about 7 minutes to execute after learning/testing/experimenting with the various options) ... <span class="anchor" id="line-23"></span><span class="anchor" id="line-24"></span><p class="line874">1. Export all data in CSV format <span class="anchor" id="line-25"></span><ol type="1"><li>open console and navigate to the web2py folder <span class="anchor" id="line-26"></span></li><li>start web2py in interactive console mode with: <span class="anchor" id="line-27"></span><span class="anchor" id="line-28"></span><ul><li style="list-style-type:none"><p class="line891"><tt class="backtick">python&nbsp;web2py.py&nbsp;-S&nbsp;your_app_name&nbsp;-M&nbsp;–P</tt> <span class="anchor" id="line-29"></span><span class="anchor" id="line-30"></span></li></ul></li><li class="gap">export data in csv format with  <span class="anchor" id="line-31"></span><span class="anchor" id="line-32"></span><ul><li style="list-style-type:none"><p class="line891"><tt class="backtick">db.export_to_csv_file(open('your_app_name_export.csv',&nbsp;'wb'))</tt> <span class="anchor" id="line-33"></span><span class="anchor" id="line-34"></span>[this stores the file in the root of the web2py directory] <span class="anchor" id="line-35"></span><span class="anchor" id="line-36"></span></li></ul></li><li class="gap"><p class="line862">exit web2py interactive console mode with <tt class="backtick">exit()</tt> <span class="anchor" id="line-37"></span><span class="anchor" id="line-38"></span></li></ol><p class="line874">2. Prepare web2py application for new database and create new database <span class="anchor" id="line-39"></span><ol type="1"><li>in console, navigate to application folder <span class="anchor" id="line-40"></span></li><li>backup existing SQLite database (and corresponding .table files) with: <span class="anchor" id="line-41"></span><span class="anchor" id="line-42"></span><ul><li style="list-style-type:none"><p class="line891"><tt class="backtick">cp&nbsp;-r&nbsp;databases&nbsp;databases_bak</tt> <span class="anchor" id="line-43"></span></li></ul></li><li>create empty databases folder with: <span class="anchor" id="line-44"></span><span class="anchor" id="line-45"></span><ul><li style="list-style-type:none"><p class="line891"><tt class="backtick">rm&nbsp;-r&nbsp;databases</tt> <span class="anchor" id="line-46"></span><span class="anchor" id="line-47"></span><p class="line891"><tt class="backtick">mkdir&nbsp;databases</tt> <span class="anchor" id="line-48"></span><span class="anchor" id="line-49"></span></li></ul></li><li class="gap">change DAL connection string in app to: <span class="anchor" id="line-50"></span><span class="anchor" id="line-51"></span><ul><li style="list-style-type:none"><p class="line891"><tt class="backtick">db&nbsp;=&nbsp;DAL('mysql://user_name:password@mysql.server/database_name')</tt> <span class="anchor" id="line-52"></span><span class="anchor" id="line-53"></span>[for pythonanywhere, the database_name is in the form user_name$database_name] <span class="anchor" id="line-54"></span><span class="anchor" id="line-55"></span></li></ul></li><li class="gap">create new empty mysql database schema (from control panel in pythonanywhere or mysql command prompt) <span class="anchor" id="line-56"></span><span class="anchor" id="line-57"></span></li></ol><p class="line874">3. Generate database tables and load data <span class="anchor" id="line-58"></span><ol type="1"><li>start web2py in interactive console mode with: <span class="anchor" id="line-59"></span><span class="anchor" id="line-60"></span><ul><li style="list-style-type:none"><p class="line891"><tt class="backtick">python&nbsp;web2py.py&nbsp;-S&nbsp;your_app_name&nbsp;-M&nbsp;–P</tt> <span class="anchor" id="line-61"></span><span class="anchor" id="line-62"></span>[this will execute the models and generate the mysql database tables and the .table files in the database directory] <span class="anchor" id="line-63"></span><span class="anchor" id="line-64"></span></li></ul></li><li class="gap">import data in csv format with: <span class="anchor" id="line-65"></span><span class="anchor" id="line-66"></span><ul><li style="list-style-type:none"><p class="line891"><tt class="backtick">db.import_from_csv_file(open('your_app_name_export.csv',&nbsp;'rb'))</tt> <span class="anchor" id="line-67"></span><span class="anchor" id="line-68"></span><p class="line891"><tt class="backtick">db.commit()&nbsp;#&nbsp;this&nbsp;is&nbsp;missing&nbsp;from&nbsp;some&nbsp;of&nbsp;the&nbsp;other&nbsp;instructions&nbsp;but&nbsp;is&nbsp;required</tt> <span class="anchor" id="line-69"></span><span class="anchor" id="line-70"></span></li></ul></li><li class="gap">exit web2py interactive console mode with: <span class="anchor" id="line-71"></span><span class="anchor" id="line-72"></span><ul><li style="list-style-type:none"><p class="line891"><tt class="backtick">exit()</tt> <span class="anchor" id="line-73"></span><span class="anchor" id="line-74"></span></li></ul></li></ol><p class="line874">4. Celebrate! <span class="anchor" id="line-75"></span><span class="anchor" id="line-76"></span><p class="line874">If you start with a new empty database, all record id's will be the same as the source database (and all foreign key references are maintained).  If the database had previous transactions, the new data will maintain all foreign key references but the id's will not match the source data (which is only important if there are any code or external references to specific id's as Alan pointed out in his posts). <span class="anchor" id="line-77"></span><span class="anchor" id="bottom"></span></div>
</div>
<hr>
2015-09-17 14:07
</body>
</html>
